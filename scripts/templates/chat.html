<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>ChatGPT Data Export</title>
    <style>
        body {
            margin: 20px;
        }
        h4 {
            font-family: sans-serif;
            margin: 0;
        }
        #root {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .conversation {
            border: 1px solid black;
            padding: 20px;
            background-color: #f3f3f3;
        }
        .message {
            white-space: pre-wrap;
            margin: 20px 0;
        }
        .author {
            font-weight: bold;
            margin-bottom: 4px;
        }
        .author::first-letter {
            text-transform: uppercase;
        }
    </style>
    <script>
        var jsonData = null;  // Ceci sera remplacé dynamiquement

        // Fonction pour charger le fichier JSON en échappant les fragments HTML
        function loadJSON() {
            fetch('/get_json')
                .then(response => response.json())
                .then(data => {
                    jsonData = data; // Utiliser le JSON avec fragments échappés
                    populateConversations(); // Appeler la fonction pour afficher les conversations
                })
                .catch(error => console.error('Erreur lors du chargement du fichier JSON:', error));
        }

        function getConversationMessages(conversation) {
            var messages = [];
            var currentNode = conversation.current_node;
            while (currentNode != null) {
                var node = conversation.mapping[currentNode];
                if (
                    node.message &&
                    node.message.content &&
                    node.message.content.content_type == "text" &&
                    node.message.content.parts.length > 0 &&
                    node.message.content.parts[0].length > 0 &&
                    (node.message.author.role !== "system" || node.message.metadata.is_user_system_message)
                ) {
                    var author = node.message.author.role;
                    if (author === "assistant") {
                        author = "ChatGPT";
                    } else if (author === "system" && node.message.metadata.is_user_system_message) {
                        author = "Custom user info";
                    }
                    messages.push({ author, text: node.message.content.parts[0] });
                }
                currentNode = node.parent;
            }
            return messages.reverse();
        }

        // Fonction pour ajouter les messages au div racine
        function populateConversations() {
            var root = document.getElementById("root");
            for (var i = 0; i < jsonData.length; i++) {
                var conversation = jsonData[i];
                var messages = getConversationMessages(conversation);
                var div = document.createElement("div");
                div.className = "conversation";
                div.innerHTML = "<h4>" + conversation.title + "</h4>";
                for (var j = 0; j < messages.length; j++) {
                    var message = document.createElement("pre");
                    message.className = "message";
                    // Affiche le texte échappé en tant que texte brut
                    message.innerHTML = `<div class="author">${messages[j].author}</div><div>${messages[j].text}</div>`;
                    div.appendChild(message);
                }
                root.appendChild(div);
            }
        }

        // Charger le fichier JSON au chargement de la page
        window.onload = loadJSON;
    </script>
</head>
<body>
<div id="root"></div>
</body>
</html>
